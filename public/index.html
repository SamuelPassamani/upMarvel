<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Heroico - Marvel GP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Bangers&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Marvel Theme Variables */
        :root {
            --marvel-red: #ED1D24;
            --marvel-blue: #0078D4;
            --marvel-yellow: #FFD700;
            --marvel-black: #1A1A1A;
            --marvel-white: #FFFFFF;
        }

        /* Pixel Art Utilities */
        .pixel-corners {
            clip-path: polygon(
                0px 4px, 4px 4px, 4px 0px, 
                calc(100% - 4px) 0px, calc(100% - 4px) 4px, 100% 4px,
                100% calc(100% - 4px), calc(100% - 4px) calc(100% - 4px), 
                calc(100% - 4px) 100%, 4px 100%, 4px calc(100% - 4px), 
                0px calc(100% - 4px)
            );
        }

        .pixel-font {
            font-family: 'Press Start 2P', 'Courier New', monospace;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        .comic-font {
            font-family: 'Bangers', 'Comic Sans MS', cursive;
            letter-spacing: 0.05em;
        }

        /* Comic Animations */
        @keyframes pixelGlow {
            0%, 100% { box-shadow: 0 0 5px currentColor; }
            50% { box-shadow: 0 0 20px currentColor, 0 0 30px currentColor; }
        }

        @keyframes comicPop {
            0% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.05) rotate(1deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        @keyframes heroEntry {
            0% { transform: translateY(-50px) scale(0.8); opacity: 0; }
            50% { transform: translateY(5px) scale(1.05); opacity: 0.8; }
            100% { transform: translateY(0) scale(1); opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateX(100%) rotate(5deg); opacity: 0; }
            to { transform: translateX(0) rotate(0deg); opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Interactive Classes */
        .comic-hover:hover {
            animation: comicPop 0.3s ease-in-out;
        }

        .pixel-glow {
            animation: pixelGlow 2s infinite;
        }

        .hero-entrance {
            animation: heroEntry 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .notification { 
            animation: slideIn 0.3s ease-out; 
        }

        /* Marvel Button Styles */
        .marvel-btn {
            position: relative;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            transition: all 0.2s;
            border: 3px solid black;
            box-shadow: 4px 4px 0px 0px rgba(0,0,0,1);
        }

        .marvel-btn:hover {
            box-shadow: 6px 6px 0px 0px rgba(0,0,0,1);
            transform: translate(-2px, -2px);
        }

        .marvel-btn:active {
            box-shadow: 2px 2px 0px 0px rgba(0,0,0,1);
            transform: translate(2px, 2px);
        }

        /* Comic Card Styles */
        .comic-card {
            border: 4px solid black;
            position: relative;
            overflow: hidden;
        }

        .comic-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle, rgba(0,0,0,0.05) 1px, transparent 1px);
            background-size: 10px 10px;
            pointer-events: none;
            z-index: 1;
        }

        /* Upload Zone Styles */
        .upload-zone {
            border: 4px dashed #666;
            transition: all 0.3s ease;
            position: relative;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .upload-zone.drag-over {
            border-color: var(--marvel-blue);
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(0, 120, 212, 0.3);
        }

        .upload-zone.drag-over .upload-content {
             opacity: 0.1;
        }

        .upload-zone.drag-over::after {
            content: '🚀 SOLTE OS ARQUIVOS AQUI!';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: var(--marvel-blue);
            color: white;
            padding: 1rem 2rem;
            font-family: 'Bangers', cursive;
            font-size: 1.2rem;
            letter-spacing: 0.1em;
            z-index: 10;
            border: 3px solid black;
            box-shadow: 4px 4px 0px 0px rgba(0,0,0,1);
        }

        /* Progress Bar Styles */
        .progress-bar {
            background: linear-gradient(90deg, #e9ecef 0%, #e9ecef 100%);
            border: 2px solid black;
            height: 20px;
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
            position: relative;
            background: linear-gradient(90deg, var(--marvel-red) 0%, var(--marvel-yellow) 50%, var(--marvel-blue) 100%);
        }

        .progress-fill.success {
            background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
        }

        .progress-fill.error {
            background: linear-gradient(90deg, #dc3545 0%, #fd7e14 100%);
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: repeating-linear-gradient(45deg, transparent, transparent 4px, rgba(255,255,255,0.2) 4px, rgba(255,255,255,0.2) 8px);
            animation: progress-stripes 1s linear infinite;
        }

        @keyframes progress-stripes {
            0% { background-position: 0 0; }
            100% { background-position: 20px 0; }
        }

        /* File Item Styles */
        .file-item {
            transition: all 0.3s ease;
            border: 3px solid black;
            position: relative;
        }
        .file-item.pending {
            background-color: #f8f9fa;
        }
        .file-item.uploading {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border-color: var(--marvel-yellow);
        }
        .file-item.success {
            background: linear-gradient(135deg, #d4edda 0%, #a3e9a4 100%);
            border-color: #28a745;
        }
        .file-item.error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border-color: #dc3545;
        }
        
        /* Status Icons */
        .status-icon {
            width: 24px; height: 24px;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid black;
            font-weight: bold;
        }
        .status-icon.pending { background: #6c757d; color: white; }
        .status-icon.uploading { background: var(--marvel-yellow); color: black; animation: pulse 1s infinite; }
        .status-icon.success { background: #28a745; color: white; }
        .status-icon.error { background: #dc3545; color: white; }

        /* Message Styles */
        .message {
            border: 3px solid black;
            padding: 1rem; margin: 1rem 0;
            position: relative;
        }
        .message.success { background: linear-gradient(135deg, #d4edda 0%, #a3e9a4 100%); border-color: #28a745; }
        .message.error { background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); border-color: #dc3545; }
        .message.loading { background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border-color: var(--marvel-yellow); }
        .message.info { background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%); border-color: var(--marvel-blue); }

        /* Custom Scrollbar */
        .file-list::-webkit-scrollbar { width: 8px; }
        .file-list::-webkit-scrollbar-track { background: #f1f1f1; border: 1px solid black; }
        .file-list::-webkit-scrollbar-thumb { background: linear-gradient(135deg, var(--marvel-red), var(--marvel-yellow)); border: 1px solid black; }
        .file-list::-webkit-scrollbar-thumb:hover { background: linear-gradient(135deg, #ff4444, #ffff44); }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-900 via-blue-900 to-purple-900 p-4">
    <!-- Background Pattern -->
    <div class="fixed inset-0 opacity-10 pointer-events-none">
        <div class="absolute inset-0" style="background-image: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px); background-size: 20px 20px;"></div>
    </div>

    <!-- Main Container -->
    <div class="relative z-10 max-w-4xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8 hero-entrance">
            <h1 class="text-4xl md:text-6xl font-bold text-yellow-400 pixel-font mb-4 pixel-glow">
                📤 UPLOAD HEROICO
            </h1>
            <p class="text-lg md:text-xl text-white comic-font">
                Envie seus arquivos com poderes épicos!
            </p>
            <div class="mt-4 inline-block">
                <div class="bg-yellow-400 text-black font-black text-sm md:text-lg px-4 md:px-6 py-2 md:py-3 rotate-3 border-4 border-black pixel-corners comic-hover">
                    MÁXIMA VELOCIDADE!
                </div>
            </div>
        </div>

        <!-- Upload Component -->
        <div class="comic-card bg-white pixel-corners shadow-2xl">
            <div class="bg-black text-white p-4 md:p-6 border-b-4 border-yellow-400">
                <h2 class="text-xl md:text-2xl font-semibold pixel-font text-center flex items-center justify-center">
                    <i data-lucide="upload-cloud" class="w-6 h-6 md:w-8 md:h-8 mr-3"></i>
                    CENTRO DE UPLOAD
                </h2>
            </div>

            <div class="p-4 md:p-6">
                <div id="uploadZone" class="upload-zone pixel-corners min-h-64 flex flex-col items-center justify-center p-8 cursor-pointer relative">
                    <div class="upload-content text-center">
                        <div class="mb-6">
                            <i data-lucide="cloud-upload" class="w-16 h-16 md:w-20 md:h-20 mx-auto text-gray-400 mb-4"></i>
                        </div>
                        <h3 class="text-xl md:text-2xl font-bold text-gray-700 comic-font mb-2">
                            🚀 ARRASTE E SOLTE SEUS ARQUIVOS
                        </h3>
                        <p class="text-gray-600 comic-font mb-6">
                            ou clique para selecionar arquivos do seu dispositivo
                        </p>
                        <div class="flex flex-col sm:flex-row gap-3 items-center justify-center">
                            <button id="browseBtn" class="marvel-btn bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 pixel-corners comic-hover">
                                <i data-lucide="folder-open" class="w-5 h-5 inline mr-2"></i>
                                <span class="pixel-font text-sm">PROCURAR ARQUIVOS</span>
                            </button>
                        </div>
                        <div class="mt-4 text-sm text-gray-500 comic-font">
                            <p>📁 Todos os tipos de arquivo aceitos</p>
                            <p>⚡ Upload em blocos para máxima eficiência</p>
                            <p>🛡️ Transferência segura e confiável</p>
                        </div>
                    </div>
                    <input type="file" id="fileInput" multiple class="hidden">
                </div>

                <div id="messagesArea" class="mt-4"></div>

                <div id="filesContainer" class="mt-6 hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-800 comic-font">
                            📋 ARQUIVOS NA FILA
                        </h3>
                    </div>
                    <div id="filesList" class="file-list space-y-3 max-h-96 overflow-y-auto p-2 bg-gray-100 border-2 border-black"></div>
                </div>
            </div>
        </div>
        <div class="text-center mt-8 text-white comic-font">
            <p class="text-sm opacity-75">
                🦸‍♂️ Powered by Marvel GP - Upload System v3.0 - Parallel Power
            </p>
        </div>
    </div>

    <script>
        lucide.createIcons();

        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx6cX2OVdRU0QKpVauOTpi00RPfPxTob-3R1azErc2YV88wPREbMR1i3qNGw8SJdlsrGg/exec";
        const CHUNK_SIZE = 75 * 1024;
        const CONCURRENT_UPLOADS = 4;

        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const browseBtn = document.getElementById('browseBtn');
        const filesContainer = document.getElementById('filesContainer');
        const filesList = document.getElementById('filesList');
        const messagesArea = document.getElementById('messagesArea');
        let fileCounter = 0;

        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        function formatTime(seconds) {
            if (seconds === Infinity || isNaN(seconds) || seconds < 0) return '--:--';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function displayMessage(message, type = 'info') {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type} pixel-corners comic-font notification`;
            const icons = { success: '✅', error: '❌', loading: '⏳', info: 'ℹ️' };
            messageEl.innerHTML = `<div class="flex items-center"><span class="text-2xl mr-3">${icons[type]}</span><span>${message}</span></div>`;
            messagesArea.innerHTML = ''; 
            messagesArea.appendChild(messageEl);
        }

        function handleFiles(files) {
            if (files.length === 0) return;
            filesContainer.classList.remove('hidden');
            const filesToUpload = Array.from(files).map(file => ({ file, uniqueId: fileCounter++ }));
            
            filesToUpload.forEach(fileObj => {
                const fileElement = document.createElement('div');
                fileElement.id = `file-item-${fileObj.uniqueId}`;
                filesList.prepend(fileElement);
                previewFile(fileObj.file, fileObj.uniqueId);
            });
            
            uploadFiles(filesToUpload);
            fileInput.value = '';
        }
        
        function previewFile(file, uniqueId) {
            const fileItem = document.getElementById(`file-item-${uniqueId}`);
            fileItem.className = 'file-item pending pixel-corners p-4 bg-white';
            fileItem.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-3 flex-1 min-w-0">
                        <div class="status-icon pending pixel-corners">⏳</div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-gray-800 comic-font truncate" title="${file.name}">📄 ${file.name}</h4>
                            <p class="text-sm text-gray-600 pixel-font">${formatBytes(file.size)}</p>
                        </div>
                    </div>
                </div>
                <div class="progress-details">
                    <div class="progress-bar pixel-corners mb-2">
                        <div class="progress-fill" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between items-center text-xs pixel-font">
                        <span class="percentage text-gray-600">0%</span>
                        <div class="progress-stats flex space-x-4">
                            <span class="speed text-blue-600"></span>
                            <span class="eta text-purple-600"></span>
                        </div>
                    </div>
                </div>
            `;
        }

        async function uploadFiles(filesToUpload) {
            if (!SCRIPT_URL || SCRIPT_URL.includes("YOUR_APPS_SCRIPT")) {
                displayMessage('URL do Google Apps Script não configurada.', 'error');
                return;
            }
            displayMessage(`Iniciando upload de ${filesToUpload.length} arquivo(s)...`, 'loading');
            const uploadPromises = filesToUpload.map(fileObject => uploadFileInChunks(fileObject.file, fileObject.uniqueId));
            await Promise.all(uploadPromises);
            displayMessage('Todos os uploads foram concluídos!', 'success');
        }

        async function uploadFileInChunks(file, uniqueId) {
            const fileItem = document.getElementById(`file-item-${uniqueId}`);
            const ui = {
                item: fileItem,
                progressBar: fileItem.querySelector('.progress-fill'),
                percentage: fileItem.querySelector('.percentage'),
                speed: fileItem.querySelector('.speed'),
                eta: fileItem.querySelector('.eta'),
                statusIcon: fileItem.querySelector('.status-icon')
            };

            const setStatus = (status, text) => {
                ui.item.className = `file-item ${status} pixel-corners p-4`;
                ui.statusIcon.className = `status-icon ${status} pixel-corners`;
                ui.statusIcon.textContent = text;
            };

            try {
                const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
                setStatus('uploading', '🚀');
                ui.percentage.textContent = 'Iniciando...';
                
                const startPayload = { action: 'start', fileName: file.name, mimeType: file.type || 'application/octet-stream', totalChunks };
                const startResponse = await apiCall(startPayload);
                if (startResponse.status !== 'success') throw new Error(`Falha ao iniciar: ${startResponse.message}`);
                const { uploadId } = startResponse;

                let uploadedChunkCount = 0;
                const startTime = Date.now();
                const chunkQueue = Array.from({ length: totalChunks }, (_, i) => i);

                const uploadChunk = async (chunkIndex) => {
                    const start = chunkIndex * CHUNK_SIZE;
                    const end = Math.min(start + CHUNK_SIZE, file.size);
                    const chunk = file.slice(start, end);
                    const chunkBase64 = await toBase64(chunk);
                    
                    const appendPayload = { action: 'append', uploadId, data: chunkBase64, chunkIndex };
                    await apiCall(appendPayload, true);
                    
                    uploadedChunkCount++;
                    const uploadedBytes = Math.min(uploadedChunkCount * CHUNK_SIZE, file.size);
                    updateProgressUI(ui, uploadedBytes, file.size, startTime);
                };

                const workerPromises = Array(CONCURRENT_UPLOADS).fill(Promise.resolve()).map(() => (
                    async () => {
                        while (chunkQueue.length > 0) {
                            const chunkIndex = chunkQueue.shift();
                            if (chunkIndex === undefined) continue;
                            await uploadChunk(chunkIndex);
                        }
                    })()
                );

                await Promise.all(workerPromises);

                ui.percentage.textContent = 'Finalizando...';
                const finishPayload = { action: 'finish', uploadId };
                const finishResponse = await apiCall(finishPayload);
                if (finishResponse.status !== 'success') throw new Error(`Falha ao finalizar: ${finishResponse.message}`);

                setStatus('success', '✅');
                ui.percentage.textContent = 'Concluído!';
                ui.speed.textContent = '';
                ui.eta.textContent = '';
                ui.progressBar.classList.add('success');

            } catch (error) {
                console.error(`ERRO FATAL durante o upload de ${file.name}:`, error);
                setStatus('error', '❌');
                ui.percentage.textContent = 'Erro!';
                ui.speed.textContent = '';
                ui.eta.textContent = '';
                ui.progressBar.classList.add('error');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'mt-2 text-xs text-red-600 comic-font bg-red-100 p-2 pixel-corners border border-red-300';
                errorDiv.innerHTML = `<strong>Erro:</strong> ${error.message}`;
                ui.item.querySelector('.progress-details').appendChild(errorDiv);
            }
        }

        function updateProgressUI(ui, uploadedBytes, totalSize, startTime) {
            const percent = (uploadedBytes / totalSize) * 100;
            ui.progressBar.style.width = `${percent}%`;
            ui.percentage.textContent = `${Math.round(percent)}%`;
            const elapsedTime = (Date.now() - startTime) / 1000;
            if (elapsedTime > 0) {
                const speed = uploadedBytes / elapsedTime;
                const remainingBytes = totalSize - uploadedBytes;
                const eta = speed > 0 ? remainingBytes / speed : 0;
                ui.speed.textContent = `⚡ ${formatBytes(speed)}/s`;
                ui.eta.textContent = `⏱️ ${formatTime(eta)}`;
            }
        }

        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }
        
        async function apiCall(payload, isAppend = false) {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(payload),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            });
            const responseText = await response.text();
            if (!response.ok) throw new Error(`Erro de rede ${response.status}: ${responseText}`);
            try {
                return JSON.parse(responseText);
            } catch (e) {
                throw new Error('A resposta do servidor não é um JSON válido.');
            }
        }

        function setupEventListeners() {
            const preventDefaults = (e) => { e.preventDefault(); e.stopPropagation(); };
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                document.body.addEventListener(eventName, preventDefaults, false);
            });
            
            uploadZone.addEventListener('dragover', () => uploadZone.classList.add('drag-over'));
            uploadZone.addEventListener('dragleave', (e) => {
                if (!uploadZone.contains(e.relatedTarget)) uploadZone.classList.remove('drag-over');
            });
            uploadZone.addEventListener('drop', (e) => {
                uploadZone.classList.remove('drag-over');
                handleFiles(e.dataTransfer.files);
            });

            browseBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                fileInput.click();
            });
            uploadZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
        }
        
        document.addEventListener('DOMContentLoaded', () => {
             if (!SCRIPT_URL || SCRIPT_URL.includes("YOUR_APPS_SCRIPT")) {
                displayMessage('⚠️ URL do Google Apps Script não configurada!', 'error');
            } else {
                displayMessage('🚀 Sistema de Upload pronto para ação!', 'success');
            }
            setupEventListeners();
        });
    </script>
</body>
</html>